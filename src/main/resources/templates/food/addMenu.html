<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header">
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div th:replace="fragments/nav-right :: nav-right"/>
<div th:replace="fragments/nav-top :: nav-top"/>
<div th:replace="fragments/bodyHeader :: bodyHeader"/>

<div class="container mt-5 mb-5">
    <form th:action th:method="post">
        <button type="submit">어택!!!</button>
        <table class="table table-sm table-dark">
            <thead>
            <tr>
                <th class="col-lg-1">First</th>
                <th class="col-lg-1.5">second</th>
                <th class="col-lg-1">third</th>
                <th class="col-lg-1">Handle</th>
                <th class="col-lg-8">Last</th>
            </tr>
            </thead>
            <tbody id="mom">
                <div  th:replace="food/fragments/appendFormToMenu :: appendFormToMenu"/>
            </tbody>
        </table>
    </form>

</div>

<div th:replace="fragments/footer :: footer"/>
</body>
</html>

<script type="application/javascript">
    $(document).ready(function(){
        const $mom = $("#mom");
        const $cloneDiv = $(".cloneDiv");
        const $clone = $(".clone").clone();
        const $addBtn = $(".addBtn");
        const $rmBtn = $(".rmBtn");
        const $upBtn = $(".upBtn");
        let currentNo = 1; // 로우 증가, 감소, 로 인덱스 번호를 지정해주고, 이미지가 change 된 곳의 이미지를 반영할수 있다.
        let changeNo = 0; // change 이벤트 발생시 - display Image change 대상을 찾기 위한 변수

        /**
         *  이벤트 버블링 방지를 tr, td 가 아닌 div 로 잡으면 인식을 못하는것인가???? 뭐지???
         * */
        $mom.on("click", "tr", function(e){
            if($addBtn.attr("class") == e.target.className){
                currentNo++;
                addHtml($clone, currentNo); // 1. currentNo 증가 + 2. append 할 로우의 인덱스 번호 값넣기 + 3. append 할 이미지가 초기화 되어야 한다.
                console.log("currentNo = " + currentNo);
            }
        });

        $mom.on("click", "tr", function(e){
            if($rmBtn.attr("class") == e.target.className){
                let targetNo = $(this).find("#noVal").html();
                if(currentNo != 1) {
                    if (confirm("[ " + targetNo + " ]번 행을 삭제 하시겠습니다.")) {
                        $(this).remove();
                        alert("삭제 되었습니다.");
                    }
                }
            }
        });



        $mom.on("click", "td", function(e){
            if($upBtn.attr("class") == e.target.className){
                console.log("upBtn click");
                $(this).find("input[type='file']").click(); // 빨간색 UP 버튼을 클릭시 같은 위치 위임한 input file 이 클릭되도록 하는것;

                makeChangeNo($(this));

            }
        });

        $mom.on("change", "td", function(e){
            if($(".upload-file").attr("class") == e.target.className) {
                let thisParent = $(this).closest("td");
                // console.log("thisParent  =  " + thisParent.html());
                let formData = new FormData();
                let singleFile = thisParent.find($("input[name='singleFile']")); // 배열로 담는구나
                let file = null;
                changeFile(formData, singleFile, file);
            }
        });

<!-- ================================ [ function field ]======================================= -->

        function addHtml(clone, currentNo){
            const cloneId = clone;
            cloneId.find("#noVal").html(currentNo);
            cloneId.find(".displaySingleFile").attr("data-id", currentNo);

            const prefix = "<tr class='clone' data-index=\"0\" height='70x'>";
            const suffix = "</tr>";

            let appendTr = prefix + cloneId.html() + suffix;

            $mom.prepend(appendTr);

        }

        function makeChangeNo(thisEm){
            let thisParent = thisEm.closest(".clone"); // 현재 위치의 부모 엘리먼트는 -> tr class = "clone"
            const displaySingleFile = thisParent.find(".displaySingleFile");
            changeNo = displaySingleFile.attr("data-id"); // 파일 change 시에 필요한 인덱스 번호
        }

        function changeFile(formData, singleFile, file){
            //파일 업로드 이벤트
            singleFile.each(function (i, arr){
                if(arr.files != null){
                    file = arr.files;
                    formData.append("singleFile", file[0]);
                }

                console.log(file);

            });



            $.ajax({
                type: "POST",
                url: "/singleFileUpload",
                enctype : "multipart/form-data",
                processData : false,
                contentType : false,
                data : formData,
                dataType : "json",
                success :function(result){
                    showSingleFile(result);
                }
            }); // end ajax
        } // end changeFile function

        function showSingleFile(result){

            let encodeFullPath =  encodeURIComponent(result.fullPath);
            console.log("encodeFullPath = " + encodeFullPath);

            $("img[data-id='"+changeNo+"']").attr("src","/display?fullPath="+encodeFullPath);

        }

    });
</script>

